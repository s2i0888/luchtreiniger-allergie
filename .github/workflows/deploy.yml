name: Deploy to Vercel/Cloudflare

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  HUGO_VERSION: 0.128.0

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0
        
    - name: Setup Hugo
      uses: peaceiris/actions-hugo@v3
      with:
        hugo-version: ${{ env.HUGO_VERSION }}
        extended: true
        
    - name: Build
      run: hugo --minify --cleanDestinationDir
      
    - name: Deploy to Vercel (if configured)
      if: env.VERCEL_TOKEN != ''
      uses: amondnet/vercel-action@v25
      with:
        vercel-token: ${{ secrets.VERCEL_TOKEN }}
        vercel-org-id: ${{ secrets.VERCEL_ORG_ID }}
        vercel-project-id: ${{ secrets.VERCEL_PROJECT_ID }}
        working-directory: ./
        
    - name: Deploy to Cloudflare Pages (if configured)
      if: env.CLOUDFLARE_API_TOKEN != ''
      uses: cloudflare/pages-action@v1
      with:
        apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
        accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        projectName: 'luchtreiniger-allergie'
        directory: './public'
        gitHubToken: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Verify deployment
      run: |
        echo "‚úÖ Build successful"
        echo "üìÅ Output directory: ./public"
        echo "üìÑ Files generated: $(find ./public -type f | wc -l)"
        echo "üåê Ready for deployment"